# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Base box - Rocky Linux 8 (RHEL 8 compatible)
  config.vm.box = "generic/rocky8"
  
  # Alternative boxes (uncomment one if preferred):
  # config.vm.box = "generic/centos8"
  # config.vm.box = "generic/alma8"
  # config.vm.box = "generic/rhel8" # Requires subscription

  # VM Name
  config.vm.hostname = "db-test-rhel8"
  
  # Network configuration
  config.vm.network "private_network", ip: "192.168.56.10"
  
  # Port forwarding for database connections
  config.vm.network "forwarded_port", guest: 1433, host: 1433  # MSSQL
  config.vm.network "forwarded_port", guest: 1521, host: 1521  # Oracle
  config.vm.network "forwarded_port", guest: 5000, host: 5000  # Sybase
  config.vm.network "forwarded_port", guest: 22, host: 2222, id: "ssh"

  # Provider-specific configuration
  config.vm.provider "virtualbox" do |vb|
    vb.name = "RHEL8-DB-Test"
    vb.memory = "4096"
    vb.cpus = 2
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--ioapic", "on"]
  end

  config.vm.provider "vmware_desktop" do |v|
    v.vmx["memsize"] = "4096"
    v.vmx["numvcpus"] = "2"
  end

  config.vm.provider "libvirt" do |v|
    v.memory = 4096
    v.cpus = 2
  end

  # Sync folders
  config.vm.synced_folder "../", "/vagrant_data", type: "rsync",
    rsync__exclude: [".git/", "*.tar.gz"]

  # Provision script
  config.vm.provision "shell", path: "provision.sh"
  
  # Optional: Run tests after provisioning
  config.vm.provision "shell", inline: <<-SHELL
    echo "======================================"
    echo "VM Setup Complete!"
    echo "======================================"
    echo "IP Address: 192.168.56.10"
    echo "SSH: vagrant ssh"
    echo ""
    echo "Test database clients:"
    echo "  sqlcmd -?"
    echo "  sqlplus -version"
    echo "  isql --version"
    echo ""
    echo "Database binaries location: /opt/db-clients"
    echo "======================================"
  SHELL
end