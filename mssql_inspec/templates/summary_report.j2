===============================================
MSSQL InSpec Compliance Scan Summary Report
===============================================
Generated: {{ ansible_date_time.iso8601 }}
===============================================

Server Information:
-------------------
Hostname: {{ mssql_server }}
Port: {{ mssql_port }}
Database: {{ mssql_database }}
Version: MSSQL {{ mssql_version }}
Service: {{ mssql_service | default('Default Instance') }}

Scan Results Summary:
---------------------
{% if inspec_results.results is defined %}
Total Controls Executed: {{ inspec_results.results | length }}

Results by Status:
{% set ns = namespace(passed=0, failed=0, skipped=0, errors=0) %}
{% for result in inspec_results.results %}
  {% if result.stdout is defined %}
    {% set json_result = result.stdout | from_json | default({}) %}
    {% if json_result.status == 'passed' %}
      {% set ns.passed = ns.passed + 1 %}
    {% elif json_result.status == 'failed' %}
      {% set ns.failed = ns.failed + 1 %}
    {% elif json_result.status == 'skipped' %}
      {% set ns.skipped = ns.skipped + 1 %}
    {% endif %}
  {% else %}
    {% set ns.errors = ns.errors + 1 %}
  {% endif %}
{% endfor %}
  Passed:  {{ ns.passed }}
  Failed:  {{ ns.failed }}
  Skipped: {{ ns.skipped }}
  Errors:  {{ ns.errors }}

Compliance Score: {{ ((ns.passed / (ns.passed + ns.failed)) * 100) | round(2) if (ns.passed + ns.failed) > 0 else 0 }}%
{% else %}
No results available
{% endif %}

Output Directory:
-----------------
{{ inspec_results_dir }}

===============================================
End of Report
===============================================